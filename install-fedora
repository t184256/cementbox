#!/usr/bin/env bash
# SPDX-License-Identifier: Unlicense
set -Eeuo pipefail; shopt -s inherit_errexit

: "${VM_HOSTNAME:=disposable-fedora}"
: "${LIBVIRT_URL:=qemu:///system}"
# alternative local example: qemu:///user
# remote example: qemu+ssh://$USER@$HOST/system
: "${VCPUS:=4}"
: "${RAM_GB:=8}"
: "${SWAP_GB:=4}"
: "${DISK_GB:=16}"
: "${FEDORA:=43}"
: "${ARCH:=x86_64}"
: "${MIRROR:=https://download.fedoraproject.org/pub/fedora/linux}"

rpm -q libvirt-client virt-install 2>/dev/null \
    || sudo dnf install libvirt-client virt-install
command -v virsh >/dev/null
command -v virt-install >/dev/null

# shellcheck disable=SC2016
if [[ -z "${SSH_KEY:-}" ]]; then
    if [[ -r ~/.ssh/id_ed25519.pub ]]; then
        SSH_KEY=$(head -n1 ~/.ssh/id_ed25519.pub)
        echo >&2 'Using ~/.ssh/id_ed25519.pub as $SSH_KEY'
    elif [[ -r ~/.ssh/id_rsa.pub ]]; then
        SSH_KEY=$(head -n1 ~/.ssh/id_rsa.pub)
        echo >&2 'Using ~/.ssh/id_rsa.pub as $SSH_KEY'
    elif [[ -r ~/.ssh/authorized_keys ]]; then
        if [[ "$(wc -l < ~/.ssh/authorized_keys)" == 1 ]]; then
            SSH_KEY=$(head -n1 ~/.ssh/authorized_keys)
            echo >&2 'Using the only key present in ~/.ssh/authorized_keys.'
        fi
    else
        echo >&2 'Please set $SSH_KEY.'
        exit 1
    fi
fi

TMP_KICKSTART=$(mktemp)
trap 'rm -f "${TMP_KICKSTART}"' EXIT

cat > "${TMP_KICKSTART}" <<EOF
url --url ${MIRROR}/releases/${FEDORA}/Everything/${ARCH}/os
repo --name fedora --baseurl ${MIRROR}/releases/${FEDORA}/Everything/${ARCH}/os
repo --name updates --baseurl ${MIRROR}/updates/${FEDORA}/Everything/${ARCH}

authselect --passalgo=sha512 --useshadow
autopart
bootloader --timeout=0
cmdline
keyboard us
lang en_US
rootpw --lock
timesource --ntp-disable
timezone UTC --utc
zerombr

firewall --disabled
network --hostname=${VM_HOSTNAME}
sshkey --username root '${SSH_KEY}'

%packages --exclude-weakdeps --timeout 900
@core --nodefaults
checkpolicy
chrony
glibc-minimal-langpack
openssh-server
qemu-guest-agent
setools-console
-dhcp-client
-dracut-config-rescue
-firewalld
-fwupd
-glibc-gconv-extra.x86_64
-iproute
-iputils
-langpacks-en
-libbpf
-man-db
-ncurses
-parted
-plymouth*
-prefixdevname
-sssd-*
%end

%post --interpreter /bin/bash --erroronfail
(
set -xEeuo pipefail; shopt -s inherit_errexit
dnf -y makecache 2>/dev/null
dnf -y update
dnf -y clean packages

btrfs filesystem mkswapfile --size ${SWAP_GB}G /swap
echo '/swap none swap defaults' >> /etc/fstab

cat > sshd-vsock.te << 'SEOF'
module sshd-vsock 1.0;
require {
    type sshd_net_t;
    type sshd_t;
    type unconfined_t;
    type chkpwd_t;
    class vsock_socket { read write };
    class process { dyntransition noatsecure rlimitinh siginh };
}
# Allow sshd_net_t to read/write vsock sockets
allow sshd_net_t sshd_t:vsock_socket { read write };
# Allow sshd dynamic transition to unconfined_t for user sessions
allow sshd_t unconfined_t:process dyntransition;
# Allow sshd to spawn chkpwd for password checking
allow sshd_t chkpwd_t:process { noatsecure rlimitinh siginh };
SEOF

checkmodule -M -m -o sshd-vsock.mod sshd-vsock.te
semodule_package -o sshd-vsock.pp -m sshd-vsock.mod
semodule -i sshd-vsock.pp
) &> /dev/hvc0
%end

poweroff
EOF

TMP_KICKSTART_NAME=$(basename "${TMP_KICKSTART}")

XARGS=(
    "inst.ks=file:/${TMP_KICKSTART_NAME}"
    "inst.repo=${MIRROR}/releases/${FEDORA}/Everything/${ARCH}/os"
    'inst.text'
    'inst.notmux'
    'console=hvc0'
)

if virsh --connect "${LIBVIRT_URL}" dominfo "${VM_HOSTNAME}" &>/dev/null; then
    virsh --connect "${LIBVIRT_URL}" destroy "${VM_HOSTNAME}" 2>/dev/null ||:
    virsh --connect "${LIBVIRT_URL}" undefine "${VM_HOSTNAME}" \
          --remove-all-storage
fi

rm -f "$HOME/.ssh/$VM_HOSTNAME.known_host"

virt-install \
    --noreboot \
    --description "autogenerated vm: $VM_HOSTNAME" \
    --connect "${LIBVIRT_URL}" \
    --name "${VM_HOSTNAME}" \
    --autostart \
    --vcpus "${VCPUS}" \
    --ram "$((RAM_GB * 1024))" \
    --disk "size=${DISK_GB}" \
    --network user \
    --vsock cid.auto=yes \
    --graphics none \
    --console pty,target_type=virtio \
    --os-variant fedora-rawhide \
    --location "${MIRROR}/releases/${FEDORA}/Everything/${ARCH}/os/" \
    --initrd-inject="${TMP_KICKSTART}" \
    --extra-args "${XARGS[*]}" \
    "$@"
virsh --connect "${LIBVIRT_URL}" start "${VM_HOSTNAME}"

for _ in {1..10}; do
    echo 'Waiting for the VM to come up...'
    timeout 10 ssh \
        -o ConnectTimeout=7 -o BatchMode=yes \
        -o StrictHostKeyChecking=accept-new \
        -o UserKnownHostsFile="$HOME/.ssh/$VM_HOSTNAME.known_host" \
        "root@${VM_HOSTNAME}" \
        true 2>/dev/null && \
            break || sleep 5
done
if [[ -r "$HOME/.ssh/$VM_HOSTNAME.known_host" ]]; then
    echo "VM's up and running!"
else
    echo >&2 "Could not SSH into the VM, something went wrong."
    echo >&2 "Is the required configuration section present in ~/.ssh/config?"
    exit 1
fi
